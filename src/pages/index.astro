---
import * as bsky from "@atproto/api";
console.log(bsky);
const { BskyAgent } = bsky;
import type { AtpSessionEvent, AtpSessionData } from "@atproto/api";

import Login from "../components/Login.astro";
import FollowersList from "../components/FollowersList";

if (Astro.request.method === "POST") {
  const data = await Astro.request.formData();
  if (data.has("logout")) {
    Astro.cookies.delete("bsky-session");
  } else if (data.has("bsky_email") && data.has("bsky_password")) {
    const AGENT = new BskyAgent({
      service: "https://bsky.social",
      persistSession: (_evt: AtpSessionEvent, sess?: AtpSessionData) => {
        if (sess) {
          Astro.cookies.set("bsky-session", sess);
        }
      },
    });
    await AGENT.login({
      identifier: data.get("bsky_email") as string,
      password: data.get("bsky_password") as string,
    });
  }
}
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>Astro</title>
  </head>
  <body class="flex flex-col gap-4 items-center p-4">
    <h1 class="text-xl">Hidden Gems ðŸ’Ž</h1>
    <div class="max-w-md">
      Order your followers by their followers/following ratio, and fight the
      dishonorable practice of fishing for "follow backs".
    </div>
    <Login />
    <FollowersList client:only />
  </body>
</html>
